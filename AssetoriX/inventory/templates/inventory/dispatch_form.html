<!DOCTYPE html>
<html>
<head>
    <title>Dispatch Report</title>
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .nav-links {
            list-style: none;
            display: flex;
            gap: 20px;
            padding: 0;
            margin: 0;
        }

        .nav-links li {
            display: inline;
        }
    </style>
</head>
<body>
<div style="display: flex; justify-content: space-between; align-items: center;">
  <h1 style="margin: 0;">AssetoriX - Asset Management System</h1>
  <span style="margin: 0;">ðŸ‘¤ {{ user.username }}</span>
</div>


<h2>IT DISPATCH DOCUMENT</h2>

<form id="dispatch_form" method="post">
    {% csrf_token %}

    <label for="store_code">Select Dispatching Store Code:</label>
    <select id="store_code" name="store_code" required>
        <option value="">-- Select Store Code --</option>
        {% for store in stores %}
            <option value="{{ store.code }}">{{ store.code }}</option>
        {% endfor %}
    </select>

    <div style="margin-top: 10px;">
        <button type="button" id="location_search">Get Assets from stock</button>
    </div>

    <p><strong>Store Name:</strong> <span id="store_name"></span></p>
    <p><strong>Address:</strong> <span id="store_address"></span></p>

    <label for="dispatcher"> Receiver:</label>
    <select id="dispatcher" name="dispatcher" required>
        <option value="">-- Select Receiver --</option>
        <option value="Akshay">Akshay</option>
        <option value="Nijin">Nijin</option>
    </select>

    <hr>

    <table id="asset_table">
        <thead>
            <tr>
                <th>Serial Number</th>
                <th>Item</th>
                <th>Model</th>
                <th>Quantity</th>
                <th>Working Status</th>
            </tr>
        </thead>
        <tbody>
            <tr class="asset-row">
                <td>
                    <select class="serial_number" disabled>
                        <option value="">-- Select --</option>
                        {% for asset in assets %}
                            <option value="{{ asset.serial_number }}">{{ asset.serial_number }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td><input type="text" class="item" readonly></td>
                <td><input type="text" class="model" readonly></td>
                <td><input type="number" class="quantity" readonly></td>
                <td><input type="text" class="working_status" readonly></td>
            </tr>
        </tbody>
    </table>
    <br>
    <button type="submit" id="dispatch_pdf">Generate Dispatch PDF</button>
</form>

<script>
$(document).ready(function () {
    const selectedSerials = new Set();

    // Fetch store info on store code selection
    $('#store_code').on('change', function () {
        const code = $(this).val();
        if (code) {
            $.get('/inventory/get_store_info/', { code: code }, function (data) {
                $('#store_name').text(data.name);
                $('#store_address').text(data.address);
            }).fail(function () {
                alert('Error loading store details.');
                $('#store_name, #store_address').text('');
            });
        } else {
            $('#store_name, #store_address').text('');
        }
    });

    // Populate assets from DIYAFAH
    $('#location_search').on('click', function () {
        const location = "DIYAFAH";
        $.get('/inventory/get_assets_by_location/', { location: location }, function (data) {
            if (!Array.isArray(data.assets)) {
                alert("Invalid response.");
                return;
            }
            $('#asset_table tbody').html('');
            selectedSerials.clear();

            const rowTemplate = `
                <tr class="asset-row">
                    <td>
                        <select class="serial_number">
                            <option value="">-- Select --</option>
                            ${data.assets.map(a => `<option value="${a.serial_number}">${a.serial_number}</option>`).join('')}
                        </select>
                    </td>
                    <td><input type="text" class="item" readonly></td>
                    <td><input type="text" class="model" readonly></td>
                    <td><input type="number" class="quantity" readonly></td>
                    <td><input type="text" class="working_status" readonly></td>
                </tr>`;
            $('#asset_table tbody').append(rowTemplate);
        }).fail(function () {
            alert('Error fetching assets from DIYAFAH.');
        });
    });

    // Handle serial number selection
    $(document).on('change', '.serial_number', function () {
        const serial = $(this).val();
        const row = $(this).closest('tr');

        if (serial) {
            selectedSerials.add(serial);
            $.get('/inventory/get_asset_info/', { serial: serial }, function (data) {
                row.find('.item').val(data.item);
                row.find('.model').val(data.model);
                row.find('.quantity').val(data.quantity);
                row.find('.working_status').val(data.working_status);
                addNewRowIfNeeded();
            }).fail(function () {
                alert('Error loading asset details.');
            });
        }
    });

    // Add new row only if last row is selected
    function addNewRowIfNeeded() {
        const lastRow = $('#asset_table tbody tr:last');
        const serial = lastRow.find('.serial_number').val();
        if (serial) {
            const newRow = lastRow.clone();
            newRow.find('input').val('');
            newRow.find('select').val('').prop('disabled', false);
            $('#asset_table tbody').append(newRow);
        }
    }

    // Handle form submit
    $('#dispatch_form').on('submit', function (e) {
        e.preventDefault();
        const formData = {
            store_code: $('#store_code').val(),
            dispatcher: $('#dispatcher').val(),
            serial_numbers: [],
            csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val()
        };

        $('.serial_number').each(function () {
            const val = $(this).val();
            if (val && !formData.serial_numbers.includes(val)) {
                formData.serial_numbers.push(val);
            }
        });

        if (!formData.store_code || !formData.dispatcher || formData.serial_numbers.length === 0) {
            alert("Please select a store, dispatcher, and at least one asset.");
            return;
        }

        $.ajax({
            type: 'POST',
            url: '/inventory/dispatch_pdf/',
            data: JSON.stringify(formData),
            contentType: 'application/json',
            xhrFields: { responseType: 'blob' },
            success: function (blob) {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `IT_DISPATCH_${formData.store_code}_Aster.pdf`;
                document.body.appendChild(a);
                a.click();
                a.remove();
            },
            error: function () {
                alert('PDF generation failed.');
            }
        });
    });
});
</script>

</body>
</html>
