
<!DOCTYPE html>
<html>
<head>
    <title>Installation Report</title>
    {% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

</head>
<style>
    .nav-links {
        list-style: none;
        display: flex;
        gap: 20px;
        padding: 0;
        margin: 0;
    }

    .nav-links li {
        display: inline;
    }
</style>
<body>
<body>
<div style="display: flex; justify-content: space-between; align-items: center;">
  <h1 style="margin: 0;">AssetoriX - Asset Management System</h1>
  <span style="margin: 0;">ðŸ‘¤ {{ user.username }}</span>
</div> <!-- Navigation Bar -->
<nav class="navbar">
    <div class="nav-container">
        <ul class="nav-links">
        <li><a href="/inventory/dashboard">Home</a></li>
            <li><a href="/inventory/dispatch-note">Dispatch Note</a></li>
            <li><a href="/inventory/return-note">Return Note</a></li>
            <li><a href="/inventory/search">Asset Lookup</a></li>
            <li><a href="/inventory/search_store_wise">Asset Inquiry</a></li>
            <li><a href="/inventory/logout">Log Out</a></li>
        </ul>
    </div>
</nav>
<h2>INSTALLATION REPORT</h2>

<form id="installation_form" method="post">
    {% csrf_token %}

    <label for="store_code">Select Store Code:</label>
    <select id="store_code" name="store_code" required>
        <option value="">-- Select Store Code --</option>
        {% for store in stores %}
            <option value="{{ store.code }}">{{ store.code }}</option>
        {% endfor %}
    </select>

    <p><strong>Store Name:</strong> <span id="store_name"></span></p>
    <p><strong>Address:</strong> <span id="store_address"></span></p>

    <hr>

    <table id="asset_table">
        <thead>
            <tr>
                <th>Serial Number</th>
                <th>Item</th>
                <th>Model</th>
                <th>Quantity</th>
            </tr>
        </thead>
        <tbody>
            <tr class="asset-row">
                <td>
                    <select class="serial_number">
                        <option value="">-- Select --</option>
                        {% for asset in assets %}
                            <option value="{{ asset.serial_number }}">{{ asset.serial_number }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td><input type="text" class="item" readonly></td>
                <td><input type="text" class="model" readonly></td>
                <td><input type="number" class="quantity" readonly></td>
            </tr>
        </tbody>
    </table>

    <button type="submit" id="generate_return_pdf">Generate IR</button>
</form>

<script>
$(document).ready(function() {
    const selectedSerials = new Set();

    // Fetch and display store info
    $('#store_code').on('change', function() {
        const code = $(this).val();
        if (code) {
            $.get('/inventory/get_store_info/', { code: code }, function(data) {
                $('#store_name').text(data.name);
                $('#store_address').text(data.address);
            }).fail(function() {
                alert('Error loading store details.');
            });
        } else {
            $('#store_name').text('');
            $('#store_address').text('');
        }
    });

    // Function to refresh dropdown options
    function updateDropdowns() {
        $('.serial_number').each(function() {
            const currentVal = $(this).val();
            $(this).find('option').each(function() {
                const optionVal = $(this).val();
                if (optionVal && selectedSerials.has(optionVal) && optionVal !== currentVal) {
                    $(this).hide();
                } else {
                    $(this).show();
                }
            });
        });
    }

    // Add new row if last row is filled
    function addNewRowIfNeeded() {
        const lastRow = $('#asset_table tbody tr:last');
        const serial = lastRow.find('.serial_number').val();
        if (serial) {
            const newRow = lastRow.clone();
            newRow.find('input').val('');
            newRow.find('select').val('');
            $('#asset_table tbody').append(newRow);
            updateDropdowns();
        }
    }

    // When serial number is selected
    $(document).on('change', '.serial_number', function() {
        const serial = $(this).val();
        const row = $(this).closest('tr');

        if (serial) {
            selectedSerials.add(serial);
            updateDropdowns();

            $.get('/inventory/get_asset_info/', { serial: serial }, function(data) {
                row.find('.item').val(data.item);
                row.find('.model').val(data.model);
                row.find('.quantity').val(data.quantity);
                addNewRowIfNeeded();
            }).fail(function() {
                alert('Error loading asset details.');
            });
        }
    });

    // On form submission - generate PDF
    $('#installation_form').on('submit', function(e) {
        e.preventDefault();

        const formData = {
            store_code: $('#store_code').val(),
            serial_numbers: [],
            csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val()
        };

        $('.serial_number').each(function() {
            const val = $(this).val();
            if (val && !formData.serial_numbers.includes(val)) {
                formData.serial_numbers.push(val);
            }
        });

        if (!formData.store_code || formData.serial_numbers.length === 0) {
            alert("Please select a store and at least one asset.");
            return;
        }

        $.ajax({
            type: 'POST',
            url: '/inventory/generate_pdf/',
            data: JSON.stringify(formData),
            contentType: 'application/json',
            xhrFields: { responseType: 'blob' },
            success: function(blob) {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "IR_{store_code}Aster.pdf";
                document.body.appendChild(a);
                a.click();
                a.remove();
            },
            error: function() {
                alert('PDF generation failed.');
            }
        });
    });
});
</script>
</body>
</html>
