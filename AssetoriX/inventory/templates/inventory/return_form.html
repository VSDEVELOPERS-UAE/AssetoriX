<!DOCTYPE html>
<html>
<head>
    <title>Return Document</title>
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .nav-links {
            list-style: none;
            display: flex;
            gap: 20px;
            padding: 0;
            margin: 0;
        }

        .nav-links li {
            display: inline;
        }
    </style>
</head>
<body>
<div style="display: flex; justify-content: space-between; align-items: center;">
  <h1 style="margin: 0;">AssetoriX - Asset Management System</h1>
  <span style="margin: 0;">ðŸ‘¤ {{ user.username }}</span>
</div>

<nav class="navbar">
    <div class="nav-container">
        <ul class="nav-links">
            <li><a href="/inventory/dashboard">Home</a></li>
        </ul>
    </div>
</nav>

<h2>IT RETURN DOCUMENT</h2>

<form id="installation_ir_form" method="post">
    {% csrf_token %}

    <label for="store_code">Select Store Code:</label>
    <select id="store_code" name="store_code" required>
        <option value="">-- Select Store Code --</option>
        {% for store in stores %}
            <option value="{{ store.code }}">{{ store.code }}</option>
        {% endfor %}
    </select>

    <div style="margin-top: 10px;">
        <label for="custodian_input">Custodian: </label>
        <input type="text" id="custodian_input" name="custodian_input" placeholder="Enter custodian">
        <button type="button" id="custodian_search">Get Assets</button>
    </div>

    <p><strong>Store Name:</strong> <span id="store_name"></span></p>
    <p><strong>Address:</strong> <span id="store_address"></span></p>

    <hr>

    <table id="asset_table">
        <thead>
            <tr>
                <th>Serial Number</th>
                <th>Item</th>
                <th>Model</th>
                <th>Quantity</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            <tr class="asset-row">
                <td>
                    <select class="serial_number" disabled>
                        <option value="">-- Select --</option>
                        {% for asset in assets %}
                            <option value="{{ asset.serial_number }}">{{ asset.serial_number }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td><input type="text" class="item" readonly></td>
                <td><input type="text" class="model" readonly></td>
                <td><input type="number" class="quantity" readonly></td>
                <td>
                    <select class="working_status">
                        <option value="">-- Select Status --</option>
                        <option value="Working">Working</option>
                        <option value="Faulty">Faulty</option>
                        <option value="Physical Damage">Physical Damage</option>
                    </select>
                    <input type="hidden" class="status_change_hidden" name="status_change_hidden[]">
                </td>
            </tr>
        </tbody>
    </table>

    <button type="submit" id="generate_ir_pdf">Generate Return PDF</button>
</form>

<script>
$(document).ready(function() {
    const selectedSerials = new Set();

    $('.serial_number').prop('disabled', true);

    $('#store_code').on('change', function() {
        const code = $(this).val();
        $('#custodian_input').val(code);

        if (code) {
            $.get('/inventory/get_store_info/', { code: code }, function(data) {
                $('#store_name').text(data.name);
                $('#store_address').text(data.address);
            }).fail(function() {
                alert('Error loading store details.');
                $('#store_name').text('');
                $('#store_address').text('');
            });
        } else {
            $('#store_name').text('');
            $('#store_address').text('');
        }
    });

    let custodianTimeout;
    $('#custodian_input').on('input', function() {
        clearTimeout(custodianTimeout);
        const custodian = $(this).val().trim();
        if (custodian.length === 4) {
            custodianTimeout = setTimeout(() => {
                $('#custodian_search').click();
            }, 300);
        }
    });

    function updateDropdowns() {
        $('.serial_number').each(function() {
            const currentVal = $(this).val();
            $(this).find('option').each(function() {
                const optionVal = $(this).val();
                if (optionVal && selectedSerials.has(optionVal) && optionVal !== currentVal) {
                    $(this).hide();
                } else {
                    $(this).show();
                }
            });
        });
    }

    function addNewRowIfNeeded() {
        const lastRow = $('#asset_table tbody tr:last');
        const serial = lastRow.find('.serial_number').val();
        if (serial) {
            const newRow = lastRow.clone();
            newRow.find('input').val('');
            newRow.find('select').val('');
            newRow.find('.serial_number').prop('disabled', false);
            $('#asset_table tbody').append(newRow);
            updateDropdowns();
        }
    }

    $(document).on('change', '.serial_number', function() {
        const serial = $(this).val();
        const row = $(this).closest('tr');

        if (serial) {
            selectedSerials.add(serial);
            updateDropdowns();

            $.get('/inventory/get_asset_info/', { serial: serial }, function(data) {
                row.find('.item').val(data.item);
                row.find('.model').val(data.model);
                row.find('.quantity').val(data.quantity);
                row.find('.working_status').val(data.working_status);
                row.find('.status_change_hidden').val(data.working_status);
                addNewRowIfNeeded();
            }).fail(function() {
                alert('Error loading asset details.');
            });
        }
    });

    // Save selected status in hidden field
    $(document).on('change', '.working_status', function() {
        const selectedStatus = $(this).val();
        $(this).closest('td').find('.status_change_hidden').val(selectedStatus);
    });

    $('#custodian_search').on('click', function() {
        const custodian = $('#custodian_input').val().trim();

        if (!custodian) {
            alert("Please enter a custodian name.");
            return;
        }

        $.get('/inventory/get_assets_by_custodian/', { custodian: custodian }, function(data) {
            if (!Array.isArray(data.assets)) {
                alert("Invalid response.");
                return;
            }

            $('#asset_table tbody').html('');
            selectedSerials.clear();

            data.assets.forEach(asset => {
                const rowTemplate = `
                    <tr class="asset-row">
                        <td>
                            <select class="serial_number">
                                <option value="">-- Select --</option>
                                ${data.assets.map(a => `<option value="${a.serial_number}">${a.serial_number}</option>`).join('')}
                            </select>
                        </td>
                        <td><input type="text" class="item" readonly></td>
                        <td><input type="text" class="model" readonly></td>
                        <td><input type="number" class="quantity" readonly></td>
                        <td>
                            <select class="working_status">
                                <option value="">-- Select Status --</option>
                                <option value="Working">Working</option>
                                <option value="Faulty">Faulty</option>
                                <option value="Physical Damage">Physical Damage</option>
                            </select>
                            <input type="hidden" class="status_change_hidden" name="status_change_hidden[]">
                        </td>
                    </tr>
                `;
                $('#asset_table tbody').append(rowTemplate);
            });

            $('.serial_number').prop('disabled', false);
        }).fail(function() {
            alert('Error fetching assets for custodian.');
        });
    });

    $('#installation_ir_form').on('submit', function(e) {
        e.preventDefault();

        const formData = {
            store_code: $('#store_code').val(),
            serial_numbers: [],
            statuses: [],
            csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val()
        };

        $('.serial_number').each(function(index) {
            const val = $(this).val();
            const status = $(this).closest('tr').find('.status_change_hidden').val();
            if (val) {
                formData.serial_numbers.push(val);
                formData.statuses.push(status || '');
            }
        });

        if (!formData.store_code || formData.serial_numbers.length === 0) {
            alert("Please select a store and at least one asset.");
            return;
        }

        $.ajax({
            type: 'POST',
            url: '/inventory/generate_ir_pdf/',
            data: JSON.stringify(formData),
            contentType: 'application/json',
            xhrFields: { responseType: 'blob' },
            success: function(blob) {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "IT_R_" + formData.store_code + "_Aster.pdf";
                document.body.appendChild(a);
                a.click();
                a.remove();
            },
            error: function() {
                alert('PDF generation failed.');
            }
        });
    });
});
</script>

</body>
</html>
